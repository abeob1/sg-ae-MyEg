10/30/2016 8:42:47 AM:query: --**20161027**--
 alter  proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Ambiguous column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
10/30/2016 8:42:57 AM:query: --**20161027**--
 alter  proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Ambiguous column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
10/30/2016 7:26:21 PM:query: DROP PROCEDURE SP_SAPB1ADDON_GST03Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'SP_SAPB1ADDON_GST03', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query)
2/15/2017 9:12:13 AM:query: DROP PROCEDURE SP_SAPB1ADDON_GST03Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'SP_SAPB1ADDON_GST03', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc [dbo].[sp_SAPB1Addon_PaymentContra]
@fromdate datetime,
@todate datetime
as
--[sp_SAPB1Addon_PaymentContra] '20010101','20200101'

declare @tbl table(PointAt nvarchar(10), TransID numeric(18,0), 
VatGroup nvarchar(20), Debit numeric(19,6), Credit numeric(19,6), Balance numeric(19,6),
BaseSum numeric(19,6), VatRat numeric(19,6), Memo nvarchar(100), transtype nvarchar(10))

insert into @tbl
exec [sp_SAPB1Addon_GST03] 'A',@fromdate,@Todate,@todate


select case when PointAt='6b' then 'Input' else 'Output' end Category,

case when PointAt='5b' then 
	(select sum(Balance) from @tbl where PointAt='5b')
else 
	(select sum(Balance) from @tbl where PointAt='6b')
 end TotalBalance,VatGroup,
convert(nvarchar(10),T0.TransID) TransID,Debit,Credit,Balance, BaseSum,VatRat, Memo,transtype, T1.Account TaxAccount, 
(select U_Value from [@GSTSETUP] where code='ContraAct') ContraAccount
from @tbl T0
join OVTG T1 on T0.VatGroup=T1.Code
left join
(
	select T0.TransID,T1.U_InvoiceEntry from OJDT T0 with(nolock) 
	join JDT1 T1 with(nolock) on T0.TransID=T1.TransID
	Where isnull(T0.U_ContraPayment,'')='Y'
) T2 on T2.U_InvoiceEntry=T0.TransID
where PointAt in ('5b','6b') and Balance<>0 and T2.TransId is nullError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@fromdate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
  proc sp_SAPB1Addon_21DO
@FromDate datetime,
@Status nvarchar(1)
as

select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 
 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,T2.Account TaxAct,
 sum(T1.VatSum*T1.OpenQty/T1.Quantity)  OutstandVatAmt
 from ODLN T0 with(nolock) 
 join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 where  T0.CANCELED='N' 
 and T1.LineStatus='O' and T0.DocStatus='O' 
 and isnull(U_21Day,'N')= 'N'--(case when @Status='Y' then 'Y' when @Status='N' then 'N' else  isnull(U_21Day,'N') end)
 and datediff(dd,T0.DocDate,@FromDate)>=21
 and @Status in ('N','A')
 group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
 having sum(T1.VatSum*T1.OpenQty/T1.Quantity)<>0

 UNION ALL

 select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 

 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,'' TaxAct,
 0  OutstandVatAmt
 from ODLN T0 with(nolock) 
 --join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 --join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 join 
 (
 select distinct B.U_InvoiceEntry, A.TransId,B.Credit from OJDT A join JDT1 B on A.TransId=B.TransId
 Where isnull(A.U_21Day,'')='Y'  and isnull(B.U_InvoiceEntry,'') <>''
 ) T3 on T0.U_21DayJE=T3.TransId

 where  isnull(U_21Day,'N')= 'Y'
 and @Status in ('Y','A')
 --group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 --T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
6). [Microsoft][SQL Server Native Client 1
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_B1Addon_GSTReturn
@FromDate datetime,
@ToDate datetime
as
declare @GST03DataTbl table
(
Point1 nvarchar(100),Point2 nvarchar(100),
Point3a datetime,Point3b datetime,
Point4 datetime,
Point5a numeric(19,6),Point5b numeric(19,6),
Point6a numeric(19,6),Point6b numeric(19,6),
Point7 numeric(19,6), Point8 numeric(19,6),
Point9 nvarchar(1),
Point10 numeric(19,6),Point11 numeric(19,6),
Point12 numeric(19,6),Point13 numeric(19,6),
Point14 numeric(19,6),Point15 numeric(19,6),
Point16 numeric(19,6),Point17 numeric(19,6),
Point18 numeric(19,6),Point19 numeric(19,6),
Point19_1Code nvarchar(30),Point19_1Value numeric(19,6), Point19_1Per numeric(19,6),
Point19_2Code nvarchar(30),Point19_2Value numeric(19,6), Point19_2Per numeric(19,6),
Point19_3Code nvarchar(30),Point19_3Value numeric(19,6), Point19_3Per numeric(19,6),
Point19_4Code nvarchar(30),Point19_4Value numeric(19,6), Point19_4Per numeric(19,6),
Point19_5Code nvarchar(30),Point19_5Value numeric(19,6), Point19_5Per numeric(19,6),
Point19_6Code nvarchar(30),Point19_6Value numeric(19,6), Point19_6Per numeric (19,6)
)
insert into @GST03DataTbl
exec sp_SAPB1Addon_GST03 'All',@FromDate,@ToDate,@ToDate


select 
isnull(CONVERT(nvarchar(100),point5a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point5b),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6b),'0.00') +'|'+
'1' +'|'+

isnull(CONVERT(nvarchar(100),point10),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point11),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point12),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point13),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point14),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point15),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point16),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point17),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point18),'0.00') +'|'+

isnull(CONVERT(nvarchar(100),Point19_1Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_1Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Value),'0.00')

txtFilestr
 from @GST03DataTbl
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt_AP
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse_AP 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
	case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')
		and Credit>0
	),0)
	else @PaidAmount*6/106  --Partial Payment
	end Debit , 
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='APInTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='APInTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OPCH T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_B1Addon_GAF
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT CompnyName BusinessName,T0.FreeZoneNo BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=2014

declare @companyxml nvarchar(max)
set @companyxml=isnull(( select * from @company FOR XML RAW ('Company'), ROOT ('Companies'), ELEMENTS),'')

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,T1.ImportEnt ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=isnull((select * from @purchase FOR XML RAW ('Purchase'), ROOT ('Purchases'), ELEMENTS),'')

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=isnull((select * from @supply FOR XML RAW ('Supply'), ROOT ('Supplies'), ELEMENTS),'')

---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, T3.CardName Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=isnull((select * from @ledger FOR XML RAW ('LedgerEntry'), ROOT ('Ledger'), ELEMENTS),'')


---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	(select COUNT(*) from OPCH where DocDate between @FromDate and @ToDate) TotalPurchaseCount,
	(select sum(LineTotal) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmount,
	(select sum(T0.VatSum) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmountGST,
	(select COUNT(*) from OINV where DocDate between @FromDate and @ToDate) TotalSupplyCount,
	(select sum(LineTotal) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmount,
	(select sum(T0.VatSum) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmountGST,
	(select COUNT(*) from OJDT where RefDate between @FromDate and @ToDate)	TotalLedgerCount,
	(select SUM(debit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerDebit,
	(select SUM(credit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerCredit,
	0 TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')

declare @GAFXml nvarchar(max)
set @GAFXml='<?xml version="1.0" encoding="utf-8"?> <GSTAuditFile>'
set @GAFXml=isnull(@GAFXml,'')+isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')
set @GAFXml=@GAFXml+'</GSTAuditFile>'

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
10). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:13 AM:query: --**20161111**--
 proc sp_B1Addon_GAFtxt
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
--sp_B1Addon_GAFtxt '2015-08-01','2015-09-01'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT top(1) CompnyName BusinessName,isnull(T0.FreeZoneNo,'') BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=Year(@FromDate)

declare @companyxml nvarchar(max)
select @companyxml='C|'+ BusinessName+'|'+ BusinessRN+'|'+GSTNumber+
	'|'+convert(nvarchar(10),PeriodStart,103)+
	'|'+convert(nvarchar(10),PeriodEnd,103)+
	'|'+convert(nvarchar(10),GAFCreationDate,103)+
	'|'+ProductVersion+'|'+GAFVersion+CHAR(13)+CHAR(10)
from @company

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,isnull(T1.ImportEnt,'') ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=''
select @purchasexml=@purchasexml+
'P|'+SupplierName+'|'+ SupplierBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+'|'+ImportDeclarationNo+'|'+
convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),PurchaseValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+
FCYCode+'|'+convert(nvarchar(100),PurchaseFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @purchase

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
isnull(T0.Dscription,'') ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=''
select @supplyxml=@supplyxml+'S|'+CustomerName+'|'+CustomerBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+
'|'+convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),SupplyValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+Country+'|'+
FCYCode+'|'+convert(nvarchar(100),SupplyFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @Supply



---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, isnull(T3.CardName,'') Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=''
select @ledgerxml=@ledgerxml+'L|'+convert(nvarchar(10),TransactionDate,103)+'|'+AccountID+'|'+AccountName+'|'+TransactionDescription+'|'+
Name+'|'+convert(nvarchar(100),TransactionID)+'|'+SourceDocumentID+'|'+SourceType+'|'+
convert(nvarchar(100),Debit)+'|'+convert(nvarchar(100),Credit)+'|'+convert(nvarchar(100),Balance)+CHAR(13)+CHAR(10)
from @ledger



---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	isnull((select COUNT(*) from @purchase),0) TotalPurchaseCount,
	isnull((select sum(PurchaseValueMYR) from @purchase),0) TotalPurchaseAmount,
	isnull((select sum(GSTValueMYR) from @purchase),0) TotalPurchaseAmountGST,
	isnull((select COUNT(*) from @Supply),0) TotalSupplyCount,
	isnull((select sum(SupplyValueMYR) from @Supply),0) TotalSupplyAmount,
	isnull((select sum(GSTValueMYR) from @Supply),0) TotalSupplyAmountGST,
	isnull((select COUNT(*) from @ledger),0)	TotalLedgerCount,
	isnull((select SUM(Debit) from @ledger),0) TotalLedgerDebit,
	isnull((select SUM(credit) from @ledger),0) TotalLedgerCredit,
	isnull((select SUM(Balance) from @ledger),0) TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=''--isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')
select @footerxml=@footerxml+'F|'
+convert(nvarchar(100),TotalPurchaseCount)+'|'+convert(nvarchar(100),TotalPurchaseAmount)+'|'+convert(nvarchar(100),TotalPurchaseAmountGST)+'|'
+convert(nvarchar(100),TotalSupplyCount)+'|'+convert(nvarchar(100),TotalSupplyAmount)+'|'+convert(nvarchar(100),TotalSupplyAmountGST)+'|'
+convert(nvarchar(100),TotalLedgerCount)+'|'+convert(nvarchar(100),TotalLedgerDebit)+'|'+convert(nvarchar(100),TotalLedgerCredit)+'|'+convert(nvarchar(100),TotalLedgerBalance)+CHAR(13)+CHAR(10)
from @footer

declare @GAFXml nvarchar(max)
set @GAFXml=isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc [dbo].[sp_SAPB1Addon_PaymentContra]
@fromdate datetime,
@todate datetime
as
--[sp_SAPB1Addon_PaymentContra] '20010101','20200101'

declare @tbl table(PointAt nvarchar(10), TransID numeric(18,0), 
VatGroup nvarchar(20), Debit numeric(19,6), Credit numeric(19,6), Balance numeric(19,6),
BaseSum numeric(19,6), VatRat numeric(19,6), Memo nvarchar(100), transtype nvarchar(10))

insert into @tbl
exec [sp_SAPB1Addon_GST03] 'A',@fromdate,@Todate,@todate


select case when PointAt='6b' then 'Input' else 'Output' end Category,

case when PointAt='5b' then 
	(select sum(Balance) from @tbl where PointAt='5b')
else 
	(select sum(Balance) from @tbl where PointAt='6b')
 end TotalBalance,VatGroup,
convert(nvarchar(10),T0.TransID) TransID,Debit,Credit,Balance, BaseSum,VatRat, Memo,transtype, T1.Account TaxAccount, 
(select U_Value from [@GSTSETUP] where code='ContraAct') ContraAccount
from @tbl T0
join OVTG T1 on T0.VatGroup=T1.Code
left join
(
	select T0.TransID,T1.U_InvoiceEntry from OJDT T0 with(nolock) 
	join JDT1 T1 with(nolock) on T0.TransID=T1.TransID
	Where isnull(T0.U_ContraPayment,'')='Y'
) T2 on T2.U_InvoiceEntry=T0.TransID
where PointAt in ('5b','6b') and Balance<>0 and T2.TransId is nullError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@fromdate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
  proc sp_SAPB1Addon_21DO
@FromDate datetime,
@Status nvarchar(1)
as

select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 
 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,T2.Account TaxAct,
 sum(T1.VatSum*T1.OpenQty/T1.Quantity)  OutstandVatAmt
 from ODLN T0 with(nolock) 
 join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 where  T0.CANCELED='N' 
 and T1.LineStatus='O' and T0.DocStatus='O' 
 and isnull(U_21Day,'N')= 'N'--(case when @Status='Y' then 'Y' when @Status='N' then 'N' else  isnull(U_21Day,'N') end)
 and datediff(dd,T0.DocDate,@FromDate)>=21
 and @Status in ('N','A')
 group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
 having sum(T1.VatSum*T1.OpenQty/T1.Quantity)<>0

 UNION ALL

 select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 

 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,'' TaxAct,
 0  OutstandVatAmt
 from ODLN T0 with(nolock) 
 --join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 --join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 join 
 (
 select distinct B.U_InvoiceEntry, A.TransId,B.Credit from OJDT A join JDT1 B on A.TransId=B.TransId
 Where isnull(A.U_21Day,'')='Y'  and isnull(B.U_InvoiceEntry,'') <>''
 ) T3 on T0.U_21DayJE=T3.TransId

 where  isnull(U_21Day,'N')= 'Y'
 and @Status in ('Y','A')
 --group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 --T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
6). [Microsoft][SQL Server Native Client 1
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_B1Addon_GSTReturn
@FromDate datetime,
@ToDate datetime
as
declare @GST03DataTbl table
(
Point1 nvarchar(100),Point2 nvarchar(100),
Point3a datetime,Point3b datetime,
Point4 datetime,
Point5a numeric(19,6),Point5b numeric(19,6),
Point6a numeric(19,6),Point6b numeric(19,6),
Point7 numeric(19,6), Point8 numeric(19,6),
Point9 nvarchar(1),
Point10 numeric(19,6),Point11 numeric(19,6),
Point12 numeric(19,6),Point13 numeric(19,6),
Point14 numeric(19,6),Point15 numeric(19,6),
Point16 numeric(19,6),Point17 numeric(19,6),
Point18 numeric(19,6),Point19 numeric(19,6),
Point19_1Code nvarchar(30),Point19_1Value numeric(19,6), Point19_1Per numeric(19,6),
Point19_2Code nvarchar(30),Point19_2Value numeric(19,6), Point19_2Per numeric(19,6),
Point19_3Code nvarchar(30),Point19_3Value numeric(19,6), Point19_3Per numeric(19,6),
Point19_4Code nvarchar(30),Point19_4Value numeric(19,6), Point19_4Per numeric(19,6),
Point19_5Code nvarchar(30),Point19_5Value numeric(19,6), Point19_5Per numeric(19,6),
Point19_6Code nvarchar(30),Point19_6Value numeric(19,6), Point19_6Per numeric (19,6)
)
insert into @GST03DataTbl
exec sp_SAPB1Addon_GST03 'All',@FromDate,@ToDate,@ToDate


select 
isnull(CONVERT(nvarchar(100),point5a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point5b),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6b),'0.00') +'|'+
'1' +'|'+

isnull(CONVERT(nvarchar(100),point10),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point11),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point12),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point13),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point14),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point15),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point16),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point17),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point18),'0.00') +'|'+

isnull(CONVERT(nvarchar(100),Point19_1Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_1Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Value),'0.00')

txtFilestr
 from @GST03DataTbl
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt_AP
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse_AP 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
	case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')
		and Credit>0
	),0)
	else @PaidAmount*6/106  --Partial Payment
	end Debit , 
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='APInTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='APInTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OPCH T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_B1Addon_GAF
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT CompnyName BusinessName,T0.FreeZoneNo BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=2014

declare @companyxml nvarchar(max)
set @companyxml=isnull(( select * from @company FOR XML RAW ('Company'), ROOT ('Companies'), ELEMENTS),'')

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,T1.ImportEnt ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=isnull((select * from @purchase FOR XML RAW ('Purchase'), ROOT ('Purchases'), ELEMENTS),'')

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=isnull((select * from @supply FOR XML RAW ('Supply'), ROOT ('Supplies'), ELEMENTS),'')

---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, T3.CardName Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=isnull((select * from @ledger FOR XML RAW ('LedgerEntry'), ROOT ('Ledger'), ELEMENTS),'')


---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	(select COUNT(*) from OPCH where DocDate between @FromDate and @ToDate) TotalPurchaseCount,
	(select sum(LineTotal) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmount,
	(select sum(T0.VatSum) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmountGST,
	(select COUNT(*) from OINV where DocDate between @FromDate and @ToDate) TotalSupplyCount,
	(select sum(LineTotal) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmount,
	(select sum(T0.VatSum) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmountGST,
	(select COUNT(*) from OJDT where RefDate between @FromDate and @ToDate)	TotalLedgerCount,
	(select SUM(debit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerDebit,
	(select SUM(credit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerCredit,
	0 TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')

declare @GAFXml nvarchar(max)
set @GAFXml='<?xml version="1.0" encoding="utf-8"?> <GSTAuditFile>'
set @GAFXml=isnull(@GAFXml,'')+isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')
set @GAFXml=@GAFXml+'</GSTAuditFile>'

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
10). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:12:57 AM:query: --**20161111**--
 proc sp_B1Addon_GAFtxt
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
--sp_B1Addon_GAFtxt '2015-08-01','2015-09-01'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT top(1) CompnyName BusinessName,isnull(T0.FreeZoneNo,'') BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=Year(@FromDate)

declare @companyxml nvarchar(max)
select @companyxml='C|'+ BusinessName+'|'+ BusinessRN+'|'+GSTNumber+
	'|'+convert(nvarchar(10),PeriodStart,103)+
	'|'+convert(nvarchar(10),PeriodEnd,103)+
	'|'+convert(nvarchar(10),GAFCreationDate,103)+
	'|'+ProductVersion+'|'+GAFVersion+CHAR(13)+CHAR(10)
from @company

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,isnull(T1.ImportEnt,'') ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=''
select @purchasexml=@purchasexml+
'P|'+SupplierName+'|'+ SupplierBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+'|'+ImportDeclarationNo+'|'+
convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),PurchaseValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+
FCYCode+'|'+convert(nvarchar(100),PurchaseFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @purchase

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
isnull(T0.Dscription,'') ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=''
select @supplyxml=@supplyxml+'S|'+CustomerName+'|'+CustomerBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+
'|'+convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),SupplyValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+Country+'|'+
FCYCode+'|'+convert(nvarchar(100),SupplyFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @Supply



---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, isnull(T3.CardName,'') Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=''
select @ledgerxml=@ledgerxml+'L|'+convert(nvarchar(10),TransactionDate,103)+'|'+AccountID+'|'+AccountName+'|'+TransactionDescription+'|'+
Name+'|'+convert(nvarchar(100),TransactionID)+'|'+SourceDocumentID+'|'+SourceType+'|'+
convert(nvarchar(100),Debit)+'|'+convert(nvarchar(100),Credit)+'|'+convert(nvarchar(100),Balance)+CHAR(13)+CHAR(10)
from @ledger



---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	isnull((select COUNT(*) from @purchase),0) TotalPurchaseCount,
	isnull((select sum(PurchaseValueMYR) from @purchase),0) TotalPurchaseAmount,
	isnull((select sum(GSTValueMYR) from @purchase),0) TotalPurchaseAmountGST,
	isnull((select COUNT(*) from @Supply),0) TotalSupplyCount,
	isnull((select sum(SupplyValueMYR) from @Supply),0) TotalSupplyAmount,
	isnull((select sum(GSTValueMYR) from @Supply),0) TotalSupplyAmountGST,
	isnull((select COUNT(*) from @ledger),0)	TotalLedgerCount,
	isnull((select SUM(Debit) from @ledger),0) TotalLedgerDebit,
	isnull((select SUM(credit) from @ledger),0) TotalLedgerCredit,
	isnull((select SUM(Balance) from @ledger),0) TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=''--isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')
select @footerxml=@footerxml+'F|'
+convert(nvarchar(100),TotalPurchaseCount)+'|'+convert(nvarchar(100),TotalPurchaseAmount)+'|'+convert(nvarchar(100),TotalPurchaseAmountGST)+'|'
+convert(nvarchar(100),TotalSupplyCount)+'|'+convert(nvarchar(100),TotalSupplyAmount)+'|'+convert(nvarchar(100),TotalSupplyAmountGST)+'|'
+convert(nvarchar(100),TotalLedgerCount)+'|'+convert(nvarchar(100),TotalLedgerDebit)+'|'+convert(nvarchar(100),TotalLedgerCredit)+'|'+convert(nvarchar(100),TotalLedgerBalance)+CHAR(13)+CHAR(10)
from @footer

declare @GAFXml nvarchar(max)
set @GAFXml=isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc [dbo].[sp_SAPB1Addon_PaymentContra]
@fromdate datetime,
@todate datetime
as
--[sp_SAPB1Addon_PaymentContra] '20010101','20200101'

declare @tbl table(PointAt nvarchar(10), TransID numeric(18,0), 
VatGroup nvarchar(20), Debit numeric(19,6), Credit numeric(19,6), Balance numeric(19,6),
BaseSum numeric(19,6), VatRat numeric(19,6), Memo nvarchar(100), transtype nvarchar(10))

insert into @tbl
exec [sp_SAPB1Addon_GST03] 'A',@fromdate,@Todate,@todate


select case when PointAt='6b' then 'Input' else 'Output' end Category,

case when PointAt='5b' then 
	(select sum(Balance) from @tbl where PointAt='5b')
else 
	(select sum(Balance) from @tbl where PointAt='6b')
 end TotalBalance,VatGroup,
convert(nvarchar(10),T0.TransID) TransID,Debit,Credit,Balance, BaseSum,VatRat, Memo,transtype, T1.Account TaxAccount, 
(select U_Value from [@GSTSETUP] where code='ContraAct') ContraAccount
from @tbl T0
join OVTG T1 on T0.VatGroup=T1.Code
left join
(
	select T0.TransID,T1.U_InvoiceEntry from OJDT T0 with(nolock) 
	join JDT1 T1 with(nolock) on T0.TransID=T1.TransID
	Where isnull(T0.U_ContraPayment,'')='Y'
) T2 on T2.U_InvoiceEntry=T0.TransID
where PointAt in ('5b','6b') and Balance<>0 and T2.TransId is nullError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@fromdate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
  proc sp_SAPB1Addon_21DO
@FromDate datetime,
@Status nvarchar(1)
as

select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 
 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,T2.Account TaxAct,
 sum(T1.VatSum*T1.OpenQty/T1.Quantity)  OutstandVatAmt
 from ODLN T0 with(nolock) 
 join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 where  T0.CANCELED='N' 
 and T1.LineStatus='O' and T0.DocStatus='O' 
 and isnull(U_21Day,'N')= 'N'--(case when @Status='Y' then 'Y' when @Status='N' then 'N' else  isnull(U_21Day,'N') end)
 and datediff(dd,T0.DocDate,@FromDate)>=21
 and @Status in ('N','A')
 group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
 having sum(T1.VatSum*T1.OpenQty/T1.Quantity)<>0

 UNION ALL

 select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 

 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,'' TaxAct,
 0  OutstandVatAmt
 from ODLN T0 with(nolock) 
 --join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 --join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 join 
 (
 select distinct B.U_InvoiceEntry, A.TransId,B.Credit from OJDT A join JDT1 B on A.TransId=B.TransId
 Where isnull(A.U_21Day,'')='Y'  and isnull(B.U_InvoiceEntry,'') <>''
 ) T3 on T0.U_21DayJE=T3.TransId

 where  isnull(U_21Day,'N')= 'Y'
 and @Status in ('Y','A')
 --group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 --T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
6). [Microsoft][SQL Server Native Client 1
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_B1Addon_GSTReturn
@FromDate datetime,
@ToDate datetime
as
declare @GST03DataTbl table
(
Point1 nvarchar(100),Point2 nvarchar(100),
Point3a datetime,Point3b datetime,
Point4 datetime,
Point5a numeric(19,6),Point5b numeric(19,6),
Point6a numeric(19,6),Point6b numeric(19,6),
Point7 numeric(19,6), Point8 numeric(19,6),
Point9 nvarchar(1),
Point10 numeric(19,6),Point11 numeric(19,6),
Point12 numeric(19,6),Point13 numeric(19,6),
Point14 numeric(19,6),Point15 numeric(19,6),
Point16 numeric(19,6),Point17 numeric(19,6),
Point18 numeric(19,6),Point19 numeric(19,6),
Point19_1Code nvarchar(30),Point19_1Value numeric(19,6), Point19_1Per numeric(19,6),
Point19_2Code nvarchar(30),Point19_2Value numeric(19,6), Point19_2Per numeric(19,6),
Point19_3Code nvarchar(30),Point19_3Value numeric(19,6), Point19_3Per numeric(19,6),
Point19_4Code nvarchar(30),Point19_4Value numeric(19,6), Point19_4Per numeric(19,6),
Point19_5Code nvarchar(30),Point19_5Value numeric(19,6), Point19_5Per numeric(19,6),
Point19_6Code nvarchar(30),Point19_6Value numeric(19,6), Point19_6Per numeric (19,6)
)
insert into @GST03DataTbl
exec sp_SAPB1Addon_GST03 'All',@FromDate,@ToDate,@ToDate


select 
isnull(CONVERT(nvarchar(100),point5a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point5b),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6b),'0.00') +'|'+
'1' +'|'+

isnull(CONVERT(nvarchar(100),point10),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point11),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point12),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point13),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point14),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point15),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point16),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point17),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point18),'0.00') +'|'+

isnull(CONVERT(nvarchar(100),Point19_1Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_1Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Value),'0.00')

txtFilestr
 from @GST03DataTbl
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt_AP
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse_AP 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
	case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')
		and Credit>0
	),0)
	else @PaidAmount*6/106  --Partial Payment
	end Debit , 
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='APInTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='APInTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OPCH T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_B1Addon_GAF
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT CompnyName BusinessName,T0.FreeZoneNo BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=2014

declare @companyxml nvarchar(max)
set @companyxml=isnull(( select * from @company FOR XML RAW ('Company'), ROOT ('Companies'), ELEMENTS),'')

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,T1.ImportEnt ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=isnull((select * from @purchase FOR XML RAW ('Purchase'), ROOT ('Purchases'), ELEMENTS),'')

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=isnull((select * from @supply FOR XML RAW ('Supply'), ROOT ('Supplies'), ELEMENTS),'')

---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, T3.CardName Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=isnull((select * from @ledger FOR XML RAW ('LedgerEntry'), ROOT ('Ledger'), ELEMENTS),'')


---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	(select COUNT(*) from OPCH where DocDate between @FromDate and @ToDate) TotalPurchaseCount,
	(select sum(LineTotal) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmount,
	(select sum(T0.VatSum) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmountGST,
	(select COUNT(*) from OINV where DocDate between @FromDate and @ToDate) TotalSupplyCount,
	(select sum(LineTotal) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmount,
	(select sum(T0.VatSum) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmountGST,
	(select COUNT(*) from OJDT where RefDate between @FromDate and @ToDate)	TotalLedgerCount,
	(select SUM(debit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerDebit,
	(select SUM(credit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerCredit,
	0 TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')

declare @GAFXml nvarchar(max)
set @GAFXml='<?xml version="1.0" encoding="utf-8"?> <GSTAuditFile>'
set @GAFXml=isnull(@GAFXml,'')+isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')
set @GAFXml=@GAFXml+'</GSTAuditFile>'

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
10). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:13:02 AM:query: --**20161111**--
 proc sp_B1Addon_GAFtxt
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
--sp_B1Addon_GAFtxt '2015-08-01','2015-09-01'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT top(1) CompnyName BusinessName,isnull(T0.FreeZoneNo,'') BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=Year(@FromDate)

declare @companyxml nvarchar(max)
select @companyxml='C|'+ BusinessName+'|'+ BusinessRN+'|'+GSTNumber+
	'|'+convert(nvarchar(10),PeriodStart,103)+
	'|'+convert(nvarchar(10),PeriodEnd,103)+
	'|'+convert(nvarchar(10),GAFCreationDate,103)+
	'|'+ProductVersion+'|'+GAFVersion+CHAR(13)+CHAR(10)
from @company

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,isnull(T1.ImportEnt,'') ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=''
select @purchasexml=@purchasexml+
'P|'+SupplierName+'|'+ SupplierBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+'|'+ImportDeclarationNo+'|'+
convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),PurchaseValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+
FCYCode+'|'+convert(nvarchar(100),PurchaseFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @purchase

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
isnull(T0.Dscription,'') ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=''
select @supplyxml=@supplyxml+'S|'+CustomerName+'|'+CustomerBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+
'|'+convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),SupplyValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+Country+'|'+
FCYCode+'|'+convert(nvarchar(100),SupplyFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @Supply



---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, isnull(T3.CardName,'') Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=''
select @ledgerxml=@ledgerxml+'L|'+convert(nvarchar(10),TransactionDate,103)+'|'+AccountID+'|'+AccountName+'|'+TransactionDescription+'|'+
Name+'|'+convert(nvarchar(100),TransactionID)+'|'+SourceDocumentID+'|'+SourceType+'|'+
convert(nvarchar(100),Debit)+'|'+convert(nvarchar(100),Credit)+'|'+convert(nvarchar(100),Balance)+CHAR(13)+CHAR(10)
from @ledger



---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	isnull((select COUNT(*) from @purchase),0) TotalPurchaseCount,
	isnull((select sum(PurchaseValueMYR) from @purchase),0) TotalPurchaseAmount,
	isnull((select sum(GSTValueMYR) from @purchase),0) TotalPurchaseAmountGST,
	isnull((select COUNT(*) from @Supply),0) TotalSupplyCount,
	isnull((select sum(SupplyValueMYR) from @Supply),0) TotalSupplyAmount,
	isnull((select sum(GSTValueMYR) from @Supply),0) TotalSupplyAmountGST,
	isnull((select COUNT(*) from @ledger),0)	TotalLedgerCount,
	isnull((select SUM(Debit) from @ledger),0) TotalLedgerDebit,
	isnull((select SUM(credit) from @ledger),0) TotalLedgerCredit,
	isnull((select SUM(Balance) from @ledger),0) TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=''--isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')
select @footerxml=@footerxml+'F|'
+convert(nvarchar(100),TotalPurchaseCount)+'|'+convert(nvarchar(100),TotalPurchaseAmount)+'|'+convert(nvarchar(100),TotalPurchaseAmountGST)+'|'
+convert(nvarchar(100),TotalSupplyCount)+'|'+convert(nvarchar(100),TotalSupplyAmount)+'|'+convert(nvarchar(100),TotalSupplyAmountGST)+'|'
+convert(nvarchar(100),TotalLedgerCount)+'|'+convert(nvarchar(100),TotalLedgerDebit)+'|'+convert(nvarchar(100),TotalLedgerCredit)+'|'+convert(nvarchar(100),TotalLedgerBalance)+CHAR(13)+CHAR(10)
from @footer

declare @GAFXml nvarchar(max)
set @GAFXml=isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc [dbo].[sp_SAPB1Addon_PaymentContra]
@fromdate datetime,
@todate datetime
as
--[sp_SAPB1Addon_PaymentContra] '20010101','20200101'

declare @tbl table(PointAt nvarchar(10), TransID numeric(18,0), 
VatGroup nvarchar(20), Debit numeric(19,6), Credit numeric(19,6), Balance numeric(19,6),
BaseSum numeric(19,6), VatRat numeric(19,6), Memo nvarchar(100), transtype nvarchar(10))

insert into @tbl
exec [sp_SAPB1Addon_GST03] 'A',@fromdate,@Todate,@todate


select case when PointAt='6b' then 'Input' else 'Output' end Category,

case when PointAt='5b' then 
	(select sum(Balance) from @tbl where PointAt='5b')
else 
	(select sum(Balance) from @tbl where PointAt='6b')
 end TotalBalance,VatGroup,
convert(nvarchar(10),T0.TransID) TransID,Debit,Credit,Balance, BaseSum,VatRat, Memo,transtype, T1.Account TaxAccount, 
(select U_Value from [@GSTSETUP] where code='ContraAct') ContraAccount
from @tbl T0
join OVTG T1 on T0.VatGroup=T1.Code
left join
(
	select T0.TransID,T1.U_InvoiceEntry from OJDT T0 with(nolock) 
	join JDT1 T1 with(nolock) on T0.TransID=T1.TransID
	Where isnull(T0.U_ContraPayment,'')='Y'
) T2 on T2.U_InvoiceEntry=T0.TransID
where PointAt in ('5b','6b') and Balance<>0 and T2.TransId is nullError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@fromdate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
  proc sp_SAPB1Addon_21DO
@FromDate datetime,
@Status nvarchar(1)
as

select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 
 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,T2.Account TaxAct,
 sum(T1.VatSum*T1.OpenQty/T1.Quantity)  OutstandVatAmt
 from ODLN T0 with(nolock) 
 join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 where  T0.CANCELED='N' 
 and T1.LineStatus='O' and T0.DocStatus='O' 
 and isnull(U_21Day,'N')= 'N'--(case when @Status='Y' then 'Y' when @Status='N' then 'N' else  isnull(U_21Day,'N') end)
 and datediff(dd,T0.DocDate,@FromDate)>=21
 and @Status in ('N','A')
 group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
 having sum(T1.VatSum*T1.OpenQty/T1.Quantity)<>0

 UNION ALL

 select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 

 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,'' TaxAct,
 0  OutstandVatAmt
 from ODLN T0 with(nolock) 
 --join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 --join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 join 
 (
 select distinct B.U_InvoiceEntry, A.TransId,B.Credit from OJDT A join JDT1 B on A.TransId=B.TransId
 Where isnull(A.U_21Day,'')='Y'  and isnull(B.U_InvoiceEntry,'') <>''
 ) T3 on T0.U_21DayJE=T3.TransId

 where  isnull(U_21Day,'N')= 'Y'
 and @Status in ('Y','A')
 --group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 --T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
6). [Microsoft][SQL Server Native Client 1
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_B1Addon_GSTReturn
@FromDate datetime,
@ToDate datetime
as
declare @GST03DataTbl table
(
Point1 nvarchar(100),Point2 nvarchar(100),
Point3a datetime,Point3b datetime,
Point4 datetime,
Point5a numeric(19,6),Point5b numeric(19,6),
Point6a numeric(19,6),Point6b numeric(19,6),
Point7 numeric(19,6), Point8 numeric(19,6),
Point9 nvarchar(1),
Point10 numeric(19,6),Point11 numeric(19,6),
Point12 numeric(19,6),Point13 numeric(19,6),
Point14 numeric(19,6),Point15 numeric(19,6),
Point16 numeric(19,6),Point17 numeric(19,6),
Point18 numeric(19,6),Point19 numeric(19,6),
Point19_1Code nvarchar(30),Point19_1Value numeric(19,6), Point19_1Per numeric(19,6),
Point19_2Code nvarchar(30),Point19_2Value numeric(19,6), Point19_2Per numeric(19,6),
Point19_3Code nvarchar(30),Point19_3Value numeric(19,6), Point19_3Per numeric(19,6),
Point19_4Code nvarchar(30),Point19_4Value numeric(19,6), Point19_4Per numeric(19,6),
Point19_5Code nvarchar(30),Point19_5Value numeric(19,6), Point19_5Per numeric(19,6),
Point19_6Code nvarchar(30),Point19_6Value numeric(19,6), Point19_6Per numeric (19,6)
)
insert into @GST03DataTbl
exec sp_SAPB1Addon_GST03 'All',@FromDate,@ToDate,@ToDate


select 
isnull(CONVERT(nvarchar(100),point5a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point5b),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6b),'0.00') +'|'+
'1' +'|'+

isnull(CONVERT(nvarchar(100),point10),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point11),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point12),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point13),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point14),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point15),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point16),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point17),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point18),'0.00') +'|'+

isnull(CONVERT(nvarchar(100),Point19_1Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_1Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Value),'0.00')

txtFilestr
 from @GST03DataTbl
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt_AP
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse_AP 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
	case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')
		and Credit>0
	),0)
	else @PaidAmount*6/106  --Partial Payment
	end Debit , 
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='APInTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='APInTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OPCH T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_B1Addon_GAF
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT CompnyName BusinessName,T0.FreeZoneNo BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=2014

declare @companyxml nvarchar(max)
set @companyxml=isnull(( select * from @company FOR XML RAW ('Company'), ROOT ('Companies'), ELEMENTS),'')

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,T1.ImportEnt ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=isnull((select * from @purchase FOR XML RAW ('Purchase'), ROOT ('Purchases'), ELEMENTS),'')

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=isnull((select * from @supply FOR XML RAW ('Supply'), ROOT ('Supplies'), ELEMENTS),'')

---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, T3.CardName Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=isnull((select * from @ledger FOR XML RAW ('LedgerEntry'), ROOT ('Ledger'), ELEMENTS),'')


---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	(select COUNT(*) from OPCH where DocDate between @FromDate and @ToDate) TotalPurchaseCount,
	(select sum(LineTotal) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmount,
	(select sum(T0.VatSum) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmountGST,
	(select COUNT(*) from OINV where DocDate between @FromDate and @ToDate) TotalSupplyCount,
	(select sum(LineTotal) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmount,
	(select sum(T0.VatSum) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmountGST,
	(select COUNT(*) from OJDT where RefDate between @FromDate and @ToDate)	TotalLedgerCount,
	(select SUM(debit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerDebit,
	(select SUM(credit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerCredit,
	0 TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')

declare @GAFXml nvarchar(max)
set @GAFXml='<?xml version="1.0" encoding="utf-8"?> <GSTAuditFile>'
set @GAFXml=isnull(@GAFXml,'')+isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')
set @GAFXml=@GAFXml+'</GSTAuditFile>'

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
10). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:46 AM:query: --**20161111**--
 proc sp_B1Addon_GAFtxt
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
--sp_B1Addon_GAFtxt '2015-08-01','2015-09-01'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT top(1) CompnyName BusinessName,isnull(T0.FreeZoneNo,'') BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=Year(@FromDate)

declare @companyxml nvarchar(max)
select @companyxml='C|'+ BusinessName+'|'+ BusinessRN+'|'+GSTNumber+
	'|'+convert(nvarchar(10),PeriodStart,103)+
	'|'+convert(nvarchar(10),PeriodEnd,103)+
	'|'+convert(nvarchar(10),GAFCreationDate,103)+
	'|'+ProductVersion+'|'+GAFVersion+CHAR(13)+CHAR(10)
from @company

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,isnull(T1.ImportEnt,'') ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=''
select @purchasexml=@purchasexml+
'P|'+SupplierName+'|'+ SupplierBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+'|'+ImportDeclarationNo+'|'+
convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),PurchaseValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+
FCYCode+'|'+convert(nvarchar(100),PurchaseFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @purchase

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
isnull(T0.Dscription,'') ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=''
select @supplyxml=@supplyxml+'S|'+CustomerName+'|'+CustomerBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+
'|'+convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),SupplyValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+Country+'|'+
FCYCode+'|'+convert(nvarchar(100),SupplyFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @Supply



---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, isnull(T3.CardName,'') Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=''
select @ledgerxml=@ledgerxml+'L|'+convert(nvarchar(10),TransactionDate,103)+'|'+AccountID+'|'+AccountName+'|'+TransactionDescription+'|'+
Name+'|'+convert(nvarchar(100),TransactionID)+'|'+SourceDocumentID+'|'+SourceType+'|'+
convert(nvarchar(100),Debit)+'|'+convert(nvarchar(100),Credit)+'|'+convert(nvarchar(100),Balance)+CHAR(13)+CHAR(10)
from @ledger



---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	isnull((select COUNT(*) from @purchase),0) TotalPurchaseCount,
	isnull((select sum(PurchaseValueMYR) from @purchase),0) TotalPurchaseAmount,
	isnull((select sum(GSTValueMYR) from @purchase),0) TotalPurchaseAmountGST,
	isnull((select COUNT(*) from @Supply),0) TotalSupplyCount,
	isnull((select sum(SupplyValueMYR) from @Supply),0) TotalSupplyAmount,
	isnull((select sum(GSTValueMYR) from @Supply),0) TotalSupplyAmountGST,
	isnull((select COUNT(*) from @ledger),0)	TotalLedgerCount,
	isnull((select SUM(Debit) from @ledger),0) TotalLedgerDebit,
	isnull((select SUM(credit) from @ledger),0) TotalLedgerCredit,
	isnull((select SUM(Balance) from @ledger),0) TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=''--isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')
select @footerxml=@footerxml+'F|'
+convert(nvarchar(100),TotalPurchaseCount)+'|'+convert(nvarchar(100),TotalPurchaseAmount)+'|'+convert(nvarchar(100),TotalPurchaseAmountGST)+'|'
+convert(nvarchar(100),TotalSupplyCount)+'|'+convert(nvarchar(100),TotalSupplyAmount)+'|'+convert(nvarchar(100),TotalSupplyAmountGST)+'|'
+convert(nvarchar(100),TotalLedgerCount)+'|'+convert(nvarchar(100),TotalLedgerDebit)+'|'+convert(nvarchar(100),TotalLedgerCredit)+'|'+convert(nvarchar(100),TotalLedgerBalance)+CHAR(13)+CHAR(10)
from @footer

declare @GAFXml nvarchar(max)
set @GAFXml=isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:54 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:54 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:54 AM:query: --**20161111**--
 proc [dbo].[sp_SAPB1Addon_PaymentContra]
@fromdate datetime,
@todate datetime
as
--[sp_SAPB1Addon_PaymentContra] '20010101','20200101'

declare @tbl table(PointAt nvarchar(10), TransID numeric(18,0), 
VatGroup nvarchar(20), Debit numeric(19,6), Credit numeric(19,6), Balance numeric(19,6),
BaseSum numeric(19,6), VatRat numeric(19,6), Memo nvarchar(100), transtype nvarchar(10))

insert into @tbl
exec [sp_SAPB1Addon_GST03] 'A',@fromdate,@Todate,@todate


select case when PointAt='6b' then 'Input' else 'Output' end Category,

case when PointAt='5b' then 
	(select sum(Balance) from @tbl where PointAt='5b')
else 
	(select sum(Balance) from @tbl where PointAt='6b')
 end TotalBalance,VatGroup,
convert(nvarchar(10),T0.TransID) TransID,Debit,Credit,Balance, BaseSum,VatRat, Memo,transtype, T1.Account TaxAccount, 
(select U_Value from [@GSTSETUP] where code='ContraAct') ContraAccount
from @tbl T0
join OVTG T1 on T0.VatGroup=T1.Code
left join
(
	select T0.TransID,T1.U_InvoiceEntry from OJDT T0 with(nolock) 
	join JDT1 T1 with(nolock) on T0.TransID=T1.TransID
	Where isnull(T0.U_ContraPayment,'')='Y'
) T2 on T2.U_InvoiceEntry=T0.TransID
where PointAt in ('5b','6b') and Balance<>0 and T2.TransId is nullError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@fromdate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:55 AM:query: --**20161111**--
  proc sp_SAPB1Addon_21DO
@FromDate datetime,
@Status nvarchar(1)
as

select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 
 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,T2.Account TaxAct,
 sum(T1.VatSum*T1.OpenQty/T1.Quantity)  OutstandVatAmt
 from ODLN T0 with(nolock) 
 join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 where  T0.CANCELED='N' 
 and T1.LineStatus='O' and T0.DocStatus='O' 
 and isnull(U_21Day,'N')= 'N'--(case when @Status='Y' then 'Y' when @Status='N' then 'N' else  isnull(U_21Day,'N') end)
 and datediff(dd,T0.DocDate,@FromDate)>=21
 and @Status in ('N','A')
 group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
 having sum(T1.VatSum*T1.OpenQty/T1.Quantity)<>0

 UNION ALL

 select 'N' ck,T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,T0.DocTotal-T0.vatsum SubTol,
 T0.VatSum,T0.DocTotal, 

 isnull((select U_Value from [@GSTSETUP] where code='DOAct'),'') AccuralAct,
 case when isnull(T0.U_21Day,'N')='Y' then 'YES' else 'NO' End Status, T0.U_21DayJE,
 datediff(dd,T0.DocDate,@FromDate) Days,'' TaxAct,
 0  OutstandVatAmt
 from ODLN T0 with(nolock) 
 --join DLN1 T1 with(nolock) on T0.DocEntry=T1.DocEntry
 --join OVTG T2 with(nolock) on T2.Code=T1.VatGroup
 join 
 (
 select distinct B.U_InvoiceEntry, A.TransId,B.Credit from OJDT A join JDT1 B on A.TransId=B.TransId
 Where isnull(A.U_21Day,'')='Y'  and isnull(B.U_InvoiceEntry,'') <>''
 ) T3 on T0.U_21DayJE=T3.TransId

 where  isnull(U_21Day,'N')= 'Y'
 and @Status in ('Y','A')
 --group by T0.DocEntry,T0.DocNum,T0.DocDate,T0.CardCode, T0.CardName,T0.NumAtCard,
 --T0.VatSum,T0.DocTotal,T0.U_21DayJE,T2.Account ,T0.U_21Day
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
6). [Microsoft][SQL Server Native Client 1
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:55 AM:query: --**20161111**--
 proc sp_B1Addon_GSTReturn
@FromDate datetime,
@ToDate datetime
as
declare @GST03DataTbl table
(
Point1 nvarchar(100),Point2 nvarchar(100),
Point3a datetime,Point3b datetime,
Point4 datetime,
Point5a numeric(19,6),Point5b numeric(19,6),
Point6a numeric(19,6),Point6b numeric(19,6),
Point7 numeric(19,6), Point8 numeric(19,6),
Point9 nvarchar(1),
Point10 numeric(19,6),Point11 numeric(19,6),
Point12 numeric(19,6),Point13 numeric(19,6),
Point14 numeric(19,6),Point15 numeric(19,6),
Point16 numeric(19,6),Point17 numeric(19,6),
Point18 numeric(19,6),Point19 numeric(19,6),
Point19_1Code nvarchar(30),Point19_1Value numeric(19,6), Point19_1Per numeric(19,6),
Point19_2Code nvarchar(30),Point19_2Value numeric(19,6), Point19_2Per numeric(19,6),
Point19_3Code nvarchar(30),Point19_3Value numeric(19,6), Point19_3Per numeric(19,6),
Point19_4Code nvarchar(30),Point19_4Value numeric(19,6), Point19_4Per numeric(19,6),
Point19_5Code nvarchar(30),Point19_5Value numeric(19,6), Point19_5Per numeric(19,6),
Point19_6Code nvarchar(30),Point19_6Value numeric(19,6), Point19_6Per numeric (19,6)
)
insert into @GST03DataTbl
exec sp_SAPB1Addon_GST03 'All',@FromDate,@ToDate,@ToDate


select 
isnull(CONVERT(nvarchar(100),point5a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point5b),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6a),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point6b),'0.00') +'|'+
'1' +'|'+

isnull(CONVERT(nvarchar(100),point10),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point11),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point12),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point13),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point14),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point15),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point16),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point17),'0.00') +'|'+
isnull(CONVERT(nvarchar(100),point18),'0.00') +'|'+

isnull(CONVERT(nvarchar(100),Point19_1Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_1Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_2Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_3Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_4Value),'0.00')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Code),'')+'|'+
isnull(CONVERT(nvarchar(100),Point19_5Value),'0.00')

txtFilestr
 from @GST03DataTbl
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:55 AM:query: --**20161111**--
 proc sp_SAPB1Addon_GSTBadDebt_AP
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@Month".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@ClaimAmt".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:55 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse_AP 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
	case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')
		and Credit>0
	),0)
	else @PaidAmount*6/106  --Partial Payment
	end Debit , 
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='APInTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='APInTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OPCH T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='APInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:55 AM:query: --**20161111**--
 proc sp_B1Addon_GAF
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT CompnyName BusinessName,T0.FreeZoneNo BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=2014

declare @companyxml nvarchar(max)
set @companyxml=isnull(( select * from @company FOR XML RAW ('Company'), ROOT ('Companies'), ELEMENTS),'')

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,T1.ImportEnt ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=isnull((select * from @purchase FOR XML RAW ('Purchase'), ROOT ('Purchases'), ELEMENTS),'')

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, t0.TaxCode , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=isnull((select * from @supply FOR XML RAW ('Supply'), ROOT ('Supplies'), ELEMENTS),'')

---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, T3.CardName Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=isnull((select * from @ledger FOR XML RAW ('LedgerEntry'), ROOT ('Ledger'), ELEMENTS),'')


---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	(select COUNT(*) from OPCH where DocDate between @FromDate and @ToDate) TotalPurchaseCount,
	(select sum(LineTotal) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmount,
	(select sum(T0.VatSum) from PCH1 T0 join OPCH T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalPurchaseAmountGST,
	(select COUNT(*) from OINV where DocDate between @FromDate and @ToDate) TotalSupplyCount,
	(select sum(LineTotal) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmount,
	(select sum(T0.VatSum) from INV1 T0 join OINV T1 on T0.docEntry=T1.DocEntry where T1.DocDate between @FromDate	and @ToDate) TotalSupplyAmountGST,
	(select COUNT(*) from OJDT where RefDate between @FromDate and @ToDate)	TotalLedgerCount,
	(select SUM(debit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerDebit,
	(select SUM(credit) from JDT1 T0 with(Nolock) join OJDT T1 with(nolock) on T0.TransID=T1.TransID where T1.RefDate between @FromDate and @ToDate) TotalLedgerCredit,
	0 TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')

declare @GAFXml nvarchar(max)
set @GAFXml='<?xml version="1.0" encoding="utf-8"?> <GSTAuditFile>'
set @GAFXml=isnull(@GAFXml,'')+isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')
set @GAFXml=@GAFXml+'</GSTAuditFile>'

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
10). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:14:55 AM:query: --**20161111**--
 proc sp_B1Addon_GAFtxt
@FromDate datetime,
@ToDate datetime
as
--set @FromDate='2012-08-01'
--set @ToDate='2012-08-30'
--sp_B1Addon_GAFtxt '2015-08-01','2015-09-01'
---------------------------COMPANY---------------------
declare @company table(
	BusinessName nvarchar(500),
	BusinessRN nvarchar(500),
	GSTNumber nvarchar(500),
	PeriodStart date,
	PeriodEnd date,
	GAFCreationDate date,
	ProductVersion nvarchar(500),
	GAFVersion nvarchar(500)
)

Insert into @company
SELECT top(1) CompnyName BusinessName,isnull(T0.FreeZoneNo,'') BusinessRN, TaxIdNum GSTNumber, T1.F_RefDate PeriodStart,T1.T_RefDate PeriodEnd,
GETDATE() GAFCreationDate,'SAP_B1_9_PL4' ProductVersion, '20150101' GAFVersion
FROM OADM T0
join OACP T1 on T1.Year=Year(@FromDate)

declare @companyxml nvarchar(max)
select @companyxml='C|'+ BusinessName+'|'+ BusinessRN+'|'+GSTNumber+
	'|'+convert(nvarchar(10),PeriodStart,103)+
	'|'+convert(nvarchar(10),PeriodEnd,103)+
	'|'+convert(nvarchar(10),GAFCreationDate,103)+
	'|'+ProductVersion+'|'+GAFVersion+CHAR(13)+CHAR(10)
from @company

---------------------------Purchase---------------------
declare @purchase table(
	SupplierName  nvarchar(500),
	SupplierBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	ImportDeclarationNo  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	PurchaseValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	FCYCode  nvarchar(500),
	PurchaseFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @purchase
select T1.CardName SupplierName, T2.LicTradNum SupplierBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber,isnull(T1.ImportEnt,'') ImportDeclarationNo, T0.LineNum LineNumber,
T0.Dscription ProductDescription, T0.LineTotal PurchaseValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') ,  T1.DocCur FCYCode, T0.TotalFrgn PurchaseFCY, T0.VatSumFrgn GSTFCY
from PCH1 T0 with(nolock)
join OPCH T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @purchasexml nvarchar(max)
set @purchasexml=''
select @purchasexml=@purchasexml+
'P|'+SupplierName+'|'+ SupplierBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+'|'+ImportDeclarationNo+'|'+
convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),PurchaseValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+
FCYCode+'|'+convert(nvarchar(100),PurchaseFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @purchase

---------------------------Supply---------------------
declare @Supply table (
	CustomerName  nvarchar(500),
	CustomerBRN  nvarchar(500),
	InvoiceDate date,
	InvoiceNumber  nvarchar(500),
	LineNumber int,
	ProductDescription  nvarchar(500),
	SupplyValueMYR numeric(18,6),
	GSTValueMYR numeric(18,6),
	TaxCode  nvarchar(500),
	Country  nvarchar(500),
	FCYCode  nvarchar(500),
	SupplyFCY numeric(18,6),
	GSTFCY numeric(18,6)
)

insert into @Supply
select T1.CardName CustomerName, T2.LicTradNum CustomerBRN,
T0.DocDate InvoiceDate,T1.NumAtCard InvoiceNumber, T0.LineNum LineNumber,
isnull(T0.Dscription,'') ProductDescription, T0.LineTotal SupplyValueMYR,
T0.VatSum GSTValueMYR, isnull(t0.TaxCode,'') , T2.Country, T1.DocCur FCYCode, T0.TotalFrgn SupplyFCY, T0.VatSumFrgn GSTFCY
from INV1 T0 with(nolock)
join OINV T1 with(nolock) on T0.DocEntry=T1.DocEntry
join OCRD T2 with(nolock) on T2.CardCode=T1.CardCode
Where T1.DocDate between @FromDate and @ToDate

declare @supplyxml nvarchar(max)
set @supplyxml=''
select @supplyxml=@supplyxml+'S|'+CustomerName+'|'+CustomerBRN+'|'+convert(nvarchar(10),InvoiceDate,103)+'|'+InvoiceNumber+
'|'+convert(nvarchar(100),LineNumber)+'|'+ProductDescription+'|'+convert(nvarchar(100),SupplyValueMYR)+'|'+
convert(nvarchar(100),GSTValueMYR)+'|'+TaxCode+'|'+Country+'|'+
FCYCode+'|'+convert(nvarchar(100),SupplyFCY)+'|'+convert(nvarchar(100),GSTFCY)+CHAR(13)+CHAR(10)
from @Supply



---------------------------Ledger---------------------
declare @ledger table (
	TransactionDate date,
	AccountID nvarchar(500),
	AccountName nvarchar(500),
	TransactionDescription nvarchar(500),
	Name nvarchar(500),
	TransactionID numeric(18,0),
	SourceType nvarchar(500),
	SourceDocumentID nvarchar(500),
	Debit numeric(18,6),
	Credit numeric(18,6),
	Balance numeric(18,6)
	
)
insert into @ledger
select T0.RefDate TransactionDate,T1.Account AccountID,T2.AcctName AccountName,
T1.LineMemo TransactionDescription, isnull(T3.CardName,'') Name,
T0.transid TransactionID, T0.TransType SourceType, T0.BaseRef SourceDocumentID,
T1.Debit,T1.Credit, 
case when DebCred ='D' then T1.BalDueDeb else T1.BalDueCred end Balance
from OJDT T0 with(nolock)
join JDT1 T1 with(nolock) on T0.TransId=T1.transid
join OACT T2 with(nolock) on T2.AcctCode=T1.Account
left join OCRD T3 with(nolock) on T3.CardCode=T1.ShortName
where T0.RefDate between @FromDate and @ToDate

declare @ledgerxml nvarchar(max)
set @ledgerxml=''
select @ledgerxml=@ledgerxml+'L|'+convert(nvarchar(10),TransactionDate,103)+'|'+AccountID+'|'+AccountName+'|'+TransactionDescription+'|'+
Name+'|'+convert(nvarchar(100),TransactionID)+'|'+SourceDocumentID+'|'+SourceType+'|'+
convert(nvarchar(100),Debit)+'|'+convert(nvarchar(100),Credit)+'|'+convert(nvarchar(100),Balance)+CHAR(13)+CHAR(10)
from @ledger



---------------------------footer---------------------
--------------optimize this by using temp table---------
declare @footer table(
TotalPurchaseCount numeric(18,6),
TotalPurchaseAmount numeric(18,6),
TotalPurchaseAmountGST numeric(18,6),
TotalSupplyCount numeric(18,6),
TotalSupplyAmount numeric(18,6),
TotalSupplyAmountGST numeric(18,6),
TotalLedgerCount numeric(18,6),
TotalLedgerDebit numeric(18,6),
TotalLedgerCredit numeric(18,6),
TotalLedgerBalance numeric(18,6)
)
insert into @footer
select 
	isnull((select COUNT(*) from @purchase),0) TotalPurchaseCount,
	isnull((select sum(PurchaseValueMYR) from @purchase),0) TotalPurchaseAmount,
	isnull((select sum(GSTValueMYR) from @purchase),0) TotalPurchaseAmountGST,
	isnull((select COUNT(*) from @Supply),0) TotalSupplyCount,
	isnull((select sum(SupplyValueMYR) from @Supply),0) TotalSupplyAmount,
	isnull((select sum(GSTValueMYR) from @Supply),0) TotalSupplyAmountGST,
	isnull((select COUNT(*) from @ledger),0)	TotalLedgerCount,
	isnull((select SUM(Debit) from @ledger),0) TotalLedgerDebit,
	isnull((select SUM(credit) from @ledger),0) TotalLedgerCredit,
	isnull((select SUM(Balance) from @ledger),0) TotalLedgerBalance

declare @footerxml nvarchar(max)
set @footerxml=''--isnull((select * from @footer FOR XML RAW ('Footer'), ELEMENTS),'')
select @footerxml=@footerxml+'F|'
+convert(nvarchar(100),TotalPurchaseCount)+'|'+convert(nvarchar(100),TotalPurchaseAmount)+'|'+convert(nvarchar(100),TotalPurchaseAmountGST)+'|'
+convert(nvarchar(100),TotalSupplyCount)+'|'+convert(nvarchar(100),TotalSupplyAmount)+'|'+convert(nvarchar(100),TotalSupplyAmountGST)+'|'
+convert(nvarchar(100),TotalLedgerCount)+'|'+convert(nvarchar(100),TotalLedgerDebit)+'|'+convert(nvarchar(100),TotalLedgerCredit)+'|'+convert(nvarchar(100),TotalLedgerBalance)+CHAR(13)+CHAR(10)
from @footer

declare @GAFXml nvarchar(max)
set @GAFXml=isnull(@companyxml,'')+isnull(@purchasexml,'')+isnull(@supplyxml,'')+isnull(@ledgerxml,'')+isnull(@footerxml,'')

--select * from @company
--select * from @purchase
--select * from @Supply
--select * from @ledger
--select * from @footer

select @GAFXml xmlGAF,LEN(@GAFXml) xmllenError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@FromDate".
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:17:19 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:21:39 AM:query: --**20161111**--
 proc sp_B1Addon_BadDebtReverse 
@InvoiceNum as nvarchar(100),
@PaidAmount as numeric(19,6)
as

select 
case when T1.DocStatus='C' then --Last Payment
	Debit -
	isnull((
		select sum(isnull(Credit,0)) from jdt1 where U_InvoiceEntry=@InvoiceNum
		and VatGroup=(select U_value from [@GSTSETUP] where code='AROutTaxCode')
		and Credit>0
	),0)
else @PaidAmount*6/106  --Partial Payment
end Debit , 
T0.BaseSum,
(select U_value from [@GSTSETUP] where code='ACT3') DrAct, 
(select U_value from [@GSTSETUP] where code='AROutTaxCode') TaxCode, 
(Select Account from OVTG where Code= (select U_value from [@GSTSETUP] 
										where code='AROutTaxCode')) CrAct 
from JDT1 T0 with(nolock)
join OINV T1 with(nolock) on T1.DocNum=@InvoiceNum
where Debit>0 and U_InvoiceEntry=@InvoiceNum

and VatGroup=(select U_value from [@GSTSETUP] where code='ARInTaxCode')

Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'proc'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Must declare the scalar variable "@InvoiceNum".
3). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'and'.
4). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'Debit'.
5). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'DrAct'.
6). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'TaxCode'.
7). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near 'CrAct'.
8). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. If this statement is a common table expression, an xmlnamespaces clause or a change tracking context clause, the previous statement must be terminated with a 
9). [Microsoft][SQL Server Native Client 11.0][SQL Server]Incorrect syntax near the keyword 'with'. I
   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:22:59 AM:query: DROP PROCEDURE sp_B1Addon_BadDebtReverseError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_B1Addon_BadDebtReverse', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query)
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: create proc sp_SAPB1Addon_GSTBadDebt
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_SAPB1Addon_PaymentContraError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_PaymentContra', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_SAPB1Addon_21DOError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_21DO', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_B1Addon_GSTReturnError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_B1Addon_GSTReturn', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: create proc sp_SAPB1Addon_GSTBadDebt_AP
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_B1Addon_BadDebtReverse_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_B1Addon_BadDebtReverse_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_B1Addon_GAFError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_B1Addon_GAF', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:19 AM:query: DROP PROCEDURE sp_B1Addon_GAFtxtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_B1Addon_GAFtxt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:22 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:22 AM:query: create proc sp_SAPB1Addon_GSTBadDebt
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:22 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:22 AM:query: create proc sp_SAPB1Addon_GSTBadDebt_AP
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:24 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:24 AM:query: create proc sp_SAPB1Addon_GSTBadDebt
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:24 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:24 AM:query: create proc sp_SAPB1Addon_GSTBadDebt_AP
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:25:46 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:26:30 AM:query: create proc sp_SAPB1Addon_GSTBadDebt
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:26:30 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:26:30 AM:query: create proc sp_SAPB1Addon_GSTBadDebt_AP
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Invalid column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:53 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:53 AM:query: create proc sp_SAPB1Addon_GSTBadDebt
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Ambiguous column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:53 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:53 AM:query: create proc sp_SAPB1Addon_GSTBadDebt_AP
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Ambiguous column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:55 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:55 AM:query: create proc sp_SAPB1Addon_GSTBadDebt
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
BaseAmount  numeric(19,6),
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT2') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='ARInTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='ARInTaxCode') TaxCode,

case when T1.TransId is null then
	case when PaidSum=0 then 
		(
			select sum(isnull(A.BaseSum,0)) from jdt1 A with(nolock) 
			where a.TransId=T0.TransId
			and a.TransType=T0.ObjType
		)
	else 0 end 
else
	(select sum(isnull(A.BaseSum,0))  from JDT1 A where A.TransId=T1.TransId)
end BaseAmount,

dbo.uf_GetTaxBalance(T0.DocEntry) Amount, T1.Number BadDebtJENo

from oinv T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Ambiguous column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:56 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:28:56 AM:query: create proc sp_SAPB1Addon_GSTBadDebt_AP
--**20161111**--
@Date datetime,
@Debitor nvarchar(100),
@Month int,
@ClaimAmt nvarchar(1),
@Status nvarchar(1)
as
declare @tbl table (ck nvarchar(1),docentry numeric(19,0), DocNum nvarchar(100), Docdate datetime, NumAtCard nvarchar(100),
CardCode nvarchar(100), CardName nvarchar(100), 
SubTol numeric(19,6), 
VatSum numeric(19,6), 
DocTotal numeric(19,6), 
paidsum numeric(19,6), 
Balance numeric(19,6), 
Status nvarchar(100),
U_BadDebtJE nvarchar(100),
CrAct nvarchar(100),
DrAct nvarchar(100), 
 
TaxCode nvarchar(100), 
Amount numeric(19,6),
BadDebtJENo nvarchar(100)
)

insert into @tbl
select 'N' ck, docentry,DocNum,docdate, NumAtCard, cardcode,CardName,DocTotal-VatSum SubTol,  
VatSum,DocTotal, paidsum , DocTotal-PaidSum Balance,
case when isnull(T0.U_BadDebt,'N')='Y' then 'YES' else 'NO' End Status,U_BadDebtJE,
(select U_Value from [@GSTSETUP] where code='ACT5') CrAct,
(
select Account from ovtg where code=
	(select U_Value from [@GSTSETUP] where code='APOutTaxCode')
) DrAct,

(select U_Value from [@GSTSETUP] where code='APOutTaxCode') TaxCode,

dbo.uf_GetTaxBalance_AP(T0.DocEntry) Amount, T1.Number BadDebtJENo

from OPCH T0 with(nolock) 
left join OJDT T1 with(nolock) on T0.U_BadDebtJE=T1.TransId

where canceled='N' and DocStatus='O'
and ((datediff(month,DocDate, getdate())>@Month) OR @month=0)
and ((cardCode=@Debitor) OR @Debitor='')
and (isnull(T0.U_BadDebt,'N')=@Status or @Status='A')

select * from @tbl  where (Amount>0 or @ClaimAmt='N')
Error: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Ambiguous column name 'U_BadDebtJE'.
2). [Microsoft][SQL Server Native Client 11.0][SQL Server]Statement(s) could not be prepared.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:30:25 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebtError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 9:30:25 AM:query: DROP PROCEDURE sp_SAPB1Addon_GSTBadDebt_APError: System.Runtime.InteropServices.COMException (0xFFFFF830): 1). [Microsoft][SQL Server Native Client 11.0][SQL Server]Cannot drop the procedure 'sp_SAPB1Addon_GSTBadDebt_AP', because it does not exist or you do not have permission.

   at SAPbobsCOM.IRecordset.DoQuery(String QueryStr)
   at GSTAddon.Functions.DoQueryReturnDT(String query) in D:\ABC\Malaysia\GST Addon\GSTExportAddon\General\Functions.vb:line 93
2/15/2017 10:57:42 AM:Login failed for user 'sa'.
2/15/2017 10:58:00 AM:Login failed for user 'sa'.
